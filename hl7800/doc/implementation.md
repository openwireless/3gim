# HL7800ライブラリの実装に関する補足

R3 2021/04/25

## HTTP/GET および HTTP/POST の実装

実装が難しいのは、ボディサイズ（ContentLength）の判断と、高速なEOD(End Of Data)の判定である。

+ レスポンスのボディサイズの判断
GETやPOSTのレスポンスのボディのサイズは、以下のケースがある。
    - ヘッダのContentLengthプロパティで、明示的にサイズ（バイト数）が指定される場合
    - ヘッダのtransfer-encodingプロパティで、chunkedが指定される場合

上記のうち、明示的にサイズが分かっている場合は特に処理的な問題はない。一方、サイズが指定されていないときはどこまでボディを読み込めば終わりまで読み切れるのかが不明であり、リソースが少ないマイコンでどのような対処を行うべきかは大変難しい。また、chunkedの正式なルールに則っておらず、まったくサイズが不明な場合もある。このような場合は、読み込みで指定されたサイズまで読み込み、その後コネクションを切断する方法が現実的である。上記のロジックは、関数getBody()に含まれている。


+ レスポンスのヘッダについて
初期のHL7800(ファームウェア4.4以前)では、ヘッダの最後に空行がないという致命的な問題を持っていた。
このため、初期のHL7800ライブラリでは、英字以外の文字が行の先頭にあれば、そこからボディ部であると判断していた（HTMLやJSONでは、データは記号で始まるので大抵の場合はうまく判定できる）
ファームウェア4.5以降ではこの問題は修正されており、ヘッダとボディの間を空行で判断することができる。
このロジックは、関数parseHeader()に含まれている。
